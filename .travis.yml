dist: trusty

language: go

go:
  - "1.11.x"

services:
  - docker

env:
  - global:
    - BIN_NAME="test"
    - IMAGE_NAME="test"
  - matrix:
    - GOOS="linux" \
      BIN_SUFFIX="arm32v7" \
      COMPILE_OPTION="CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=7"
    - GOOS="linux" \
      BIN_SUFFIX="amd64" \
      COMPILE_OPTION="CGO_ENABLED=0 GOOS=linux GOARCH=amd64"

before_install:
  - go version

install:
  - go get -t -v ./...

before_script:
  - go test

script:
  - $($COMPILE_OPTION) go build -v -o ${BIN_NAME}"_"${GOOS}"_"${BIN_SUFFIX}

before_deploy:
  - env

deploy:
  - provider: releases
    api_key: "$GITHUB_API_KEY"
    file:
      - $LINUX_ARM32V7_FILE_NAME
      - $LINUX_AMD64_FILE_NAME
    skip_cleanup: true
    on:
      tags: true
  - deploy:
    provider: script
    script: bash docker/deploy.sh
    skip_cleanup: true
    on:
      tags: true
